<!DOCTYPE html>
<html>

<head>
  <title>AI Racing Leaderboard</title>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:300|Source+Code+Pro:300" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="hlua/highlight.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/treant-js/1.0/Treant.css">
  <script src="hlua/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
</head>

<body class="dimmed">
  <header>
    <h1>AI Racing Marketplace</h1>
  </header>
  <main class="chart" id="treecontainer"></main>
  <aside id="scriptviewcontainer"></aside>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/treant-js/1.0/Treant.min.js"></script>
  <script>
    var market;
    var request = new XMLHttpRequest();
    request.open("GET", "marketplace.json", true);
    request.send(null);
    request.onreadystatechange = function() {
      if (request.readyState === 4 && request.status === 200) {
        market = JSON.parse(request.responseText);
        var struct = {
          chart: {
            container: "#treecontainer",
            levelSeparation: 200,
            siblingSeparation: 170,
            subTeeSeparation: 20,
            padding: 50,
            nodeAlign: "BOTTOM",
            node: {
              HTMLclass: "marketplacetree"
            },
            connectors: {
              type: "curve",
              style: {
                "stroke-width": 5,
                "stroke-linecap": "round",
                "stroke": "#fff",
                "opacity": 0.1
              }
            }
          },
          nodeStructure: market
        };
        new Treant(struct);
        [].forEach.call(document.getElementsByClassName("node"), function(node) {
          node.addEventListener("click", function(e) {
            loadScript(node.getElementsByClassName("node-desc")[0].innerHTML);
          });
        });
      }
    }

    function getParent(start, ID) {
      console.log("in func");
      for (var x = 0; x < start.children.length; x++) {
        console.log("in lop");
        if (start.children[x].text.desc == ID) return start;
        var p = getParent(start.children[x], ID);
        if (p !== null) return p;
      }
      return null;
    }

    function getChildFromParent(parent, ID) {
      for (var x = 0; x < parent.children.length; x++) {
        if (parent.children[x].text.desc == ID) return parent.children[x];
      }
      return null;
    }
    
    function loadScript(ID) {
      var container = document.getElementById("scriptviewcontainer");
      var entryparent = getParent(market, ID);
      console.log(entryparent);
      var entry = (entryparent == null) ? market : getChildFromParent(entryparent, ID);
      var script = entry.script;
      var name = entry.text.name;
      container.innerHTML = '<div class="asidecontainer"><nav><h2>(' + ID + ') ' + name + '\'s Script</h2><div class="spacer"></div><div class="jbutton" onclick="copyTweak(' + ID + ')">tweak</div></nav><pre><code>' + script + '</pre></code></div>';
      container.addEventListener("click", function(e) {
        e = window.event || e;
        if (e.target === this || e.target.tagName === "aside") hideScript();
      });
      hljs.highlightBlock(container.getElementsByTagName("code")[0]);
      container.style.display = "flex";
    }

    function hideScript() {
      var container = document.getElementById("scriptviewcontainer");
      container.innerHTML = "";
      container.style.display = "none";
    }

    function copyTweak(ID) {
      var entry = getChildFromParent(getParent(market, ID), ID);
      var script = entry.script;
      // TODO clipboard
      alert("Script copied to clipboard :D");
    }
  </script>
</body>

</html>
