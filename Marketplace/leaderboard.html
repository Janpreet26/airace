<!DOCTYPE html>
<html>

<head>
  <title>AI Racing Leaderboard</title>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:300|Source+Code+Pro:300" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="hlua/highlight.css">
  <script src="hlua/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
</head>

<body>
  <header>
    <h1>AI Racing Leaderboard</h1>
  </header>
  <main><ol id="leaderboardcontainer"></ol></main>
  <aside id="scriptviewcontainer"></aside>
  <script>
    var entries;
    var request = new XMLHttpRequest();
    request.open("GET", "leaderboard.json", true);
    request.send(null);
    request.onreadystatechange = function() {
      if (request.readyState === 4 && request.status === 200) {
        var cont = document.getElementById("leaderboardcontainer");
        var place = 0;
        entries = JSON.parse(request.responseText).entries;
        [].forEach.call(entries, function(entry) {
          place += 1;
          var specialclass = "";
          if (place == 1) specialclass = " firstplace";
          else if (place == 2) specialclass = " secondplace";
          else if (place == 3) specialclass = " thirdplace";
          var time = entry.stats.time;
          var t = (Math.floor(time / 60000)) + ":" + (Math.floor(time / 1000) % 60);
          var tm = "." + (time % 1000);
          var n = entry.name;
          cont.innerHTML += '<li><span class="place' + specialclass + '">' + place + '</span><span class="spacer"></span><span class="time">' + t + '</span><span class="millis">' + tm + '</span><span class="mspacer"></span><span class="nickname">' + n + '</span><span class="bspacer"></span><span class="script jbutton" onclick="loadScript(' + place + ')">View Script</span></li>'
        });
      }
    }

    function loadScript(no) {
      var container = document.getElementById("scriptviewcontainer");
      var entry = entries[no - 1];
      var script = entry.script;
      var ID = entry.ID;
      var name = entry.name;
      container.innerHTML = '<div class="asidecontainer"><nav><h2>(' + ID + ') ' + name + '\'s Script</h2><div class="spacer"></div><div class="jbutton" onclick="copyTweak('+no+')">tweak</div></nav><pre><code>' + script + '</pre></code></div>';
      container.addEventListener("click", function(e) {
        e = window.event || e;
        if (e.target === this || e.target.tagName === "aside") hideScript();
      });
      hljs.highlightBlock(container.getElementsByTagName("code")[0]);
      container.style.display = "block";
    }

    function hideScript() {
      var container = document.getElementById("scriptviewcontainer");
      container.innerHTML = "";
      container.style.display = "none";
    }

    function copyTweak(no) {
      var entry = entries[no - 1];
      var ID = entry.ID;
      var script = entry.script;
      // TODO clipboard
      alert("Script copied to clipboard :D");
    }
  </script>
</body>

</html>
